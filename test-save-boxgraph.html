<!DOCTYPE html>
<html>
<head>
    <title>Test BoxGraph Save</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            background: #f0f0f0;
        }
        .error {
            background: #ffcccc;
            color: #cc0000;
        }
        .success {
            background: #ccffcc;
            color: #008800;
        }
    </style>
</head>
<body>
    <h1>Test BoxGraph Save</h1>
    <p>Open this page after loading a project in OpenDAW, then use the buttons below to test BoxGraph saving.</p>
    
    <div>
        <button onclick="checkStatus()">Check Status</button>
        <button onclick="saveBoxGraph()">Save BoxGraph Now</button>
        <button onclick="checkDatabase()">Check Database</button>
    </div>
    
    <div id="status"></div>
    
    <script>
        const statusDiv = document.getElementById('status');
        
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            div.className = isError ? 'error' : '';
            statusDiv.appendChild(div);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        async function checkStatus() {
            log('Checking Timeline Sync status...');
            
            // Open OpenDAW in another tab
            const opendawWindow = window.open('http://localhost:8080', '_blank');
            
            setTimeout(() => {
                try {
                    // Try to access the Timeline Sync
                    if (opendawWindow.syncSphereTimelineSync) {
                        log('✅ Timeline Sync is available');
                        
                        const service = opendawWindow.syncSphereTimelineSync.service;
                        const boxCount = Array.from(service.project.boxGraph.boxes()).length;
                        log(`Box count: ${boxCount}`);
                        
                        if (boxCount > 6) {
                            log('✅ Project has content (more than 6 base boxes)');
                        } else {
                            log('⚠️ Project only has base boxes');
                        }
                    } else {
                        log('❌ Timeline Sync not found. Make sure to join a room first.', true);
                    }
                } catch (error) {
                    log('❌ Error: ' + error.message, true);
                }
            }, 3000);
        }
        
        async function saveBoxGraph() {
            log('Attempting to save BoxGraph...');
            
            // Try to find OpenDAW window
            const windows = window.open('', 'opendaw');
            
            if (!windows || !windows.syncSphereTimelineSync) {
                log('❌ Cannot find OpenDAW window or Timeline Sync', true);
                log('Please make sure OpenDAW is open and you have joined a room');
                return;
            }
            
            try {
                await windows.syncSphereTimelineSync.triggerBoxGraphSave();
                log('✅ BoxGraph save triggered successfully');
                log('Check the browser console in OpenDAW for detailed logs');
            } catch (error) {
                log('❌ Error saving BoxGraph: ' + error.message, true);
            }
        }
        
        async function checkDatabase() {
            log('Checking database for BoxGraph data...');
            
            // This would need to be implemented as an API endpoint
            log('⚠️ Database check not implemented yet');
            log('Run "docker exec -it opendaw_synxsphere_dev sh -c \\"cd /app && node check-project-bundle.js\\"" in terminal');
        }
        
        // Auto-check on load
        window.onload = () => {
            log('Test page loaded. Use the buttons above to test BoxGraph saving.');
        };
    </script>
</body>
</html> 