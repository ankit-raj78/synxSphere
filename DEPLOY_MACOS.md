# 🚀 SyncSphere AWS Deployment (macOS)

Complete AWS deployment guide for SyncSphere audio collaboration platform on macOS.

## 📋 Quick Start

### Prerequisites Setup
```bash
# Install AWS CLI
brew install awscli

# Install PostgreSQL client
brew install postgresql

# Install Docker Desktop
brew install --cask docker

# Configure AWS credentials
aws configure
```

### One-Command Deployment
```bash
# Build and test locally first
./build-and-test.sh

# Complete deployment with sample data
./deploy-aws.sh

# Set up database
./setup-aws-database.sh

# Validate deployment
./validate-aws-deployment.sh
```

## 🏗️ Architecture Overview

### AWS Services Used
- **ECS Fargate**: Container orchestration
- **ECR**: Docker image registry
- **RDS PostgreSQL**: Managed database (db.t3.micro)
- **Secrets Manager**: Database credentials
- **VPC**: Network isolation (uses default VPC)
- **Security Groups**: Database access control

### Cost Estimate
- **ECS Fargate**: ~$15-30/month (1 task always running)
- **RDS db.t3.micro**: ~$15-20/month
- **Storage & Transfer**: ~$2-8/month
- **Total**: ~$32-58/month

## 📜 Available Scripts

### `./build-and-test.sh`
```bash
# Build everything and run tests
./build-and-test.sh

# Build frontend only
./build-and-test.sh --frontend-only

# Build Docker image only  
./build-and-test.sh --docker-only

# Run tests only
./build-and-test.sh --test-only
```

### `./deploy-aws.sh`
```bash
# Full deployment
./deploy-aws.sh

# Deploy to specific region
./deploy-aws.sh --region us-west-2

# Skip infrastructure setup (app update only)
./deploy-aws.sh --skip-infrastructure

# Skip Docker build (infrastructure only)
./deploy-aws.sh --skip-build
```

### `./setup-aws-database.sh`
```bash
# Setup with sample data
./setup-aws-database.sh

# Setup without sample data
./setup-aws-database.sh --skip-sample-data

# Custom region
./setup-aws-database.sh --region us-west-2

# Custom database password
./setup-aws-database.sh --db-password mypassword
```

### `./validate-aws-deployment.sh`
```bash
# Check all deployment components
./validate-aws-deployment.sh
```

## 🔧 Prerequisites

### Required Software
1. **AWS CLI**: `brew install awscli`
2. **Docker Desktop**: `brew install --cask docker`
3. **Node.js**: `brew install node`
4. **PostgreSQL Client**: `brew install postgresql`
5. **jq**: `brew install jq` (for JSON parsing)

### AWS Account Setup
1. Create AWS account at [aws.amazon.com](https://aws.amazon.com)
2. Create IAM user with these permissions:
   - ECS Full Access
   - ECR Full Access  
   - RDS Full Access
   - EC2 Full Access
   - Secrets Manager Full Access
   - IAM Pass Role (for ECS task execution)

3. Configure AWS CLI:
   ```bash
   aws configure
   # Enter: Access Key ID, Secret Access Key, Region (us-east-1), Output format (json)
   ```

## 🚀 Deployment Process

### Step 1: Local Build and Test
```bash
# Ensure everything works locally
./build-and-test.sh
```

This will:
- ✅ Check environment and dependencies
- ✅ Install npm dependencies
- ✅ Build Next.js application
- ✅ Run tests and linting
- ✅ Build Docker image
- ✅ Test Docker container

### Step 2: Deploy to AWS
```bash
# Deploy infrastructure and application
./deploy-aws.sh
```

This will:
- ✅ Check AWS credentials and prerequisites
- ✅ Create ECR repository
- ✅ Create ECS cluster
- ✅ Build and push Docker image to ECR
- ✅ Create/update ECS task definition
- ✅ Display deployment information

### Step 3: Setup Database
```bash
# Create RDS PostgreSQL instance
./setup-aws-database.sh
```

This will:
- ✅ Create DB subnet group
- ✅ Create security group for database
- ✅ Create RDS PostgreSQL instance
- ✅ Wait for instance to be available
- ✅ Import database schema and sample data
- ✅ Store credentials in AWS Secrets Manager

### Step 4: Validate Deployment
```bash
# Check everything is working
./validate-aws-deployment.sh
```

This will:
- ✅ Validate ECR repository and images
- ✅ Check ECS cluster and service status
- ✅ Verify RDS instance health
- ✅ Confirm Secrets Manager setup
- ✅ Display access information

## 🔧 Configuration

### Environment Variables
The application uses these environment variables in AWS:

```bash
NODE_ENV=production
PORT=3000

# Database (retrieved from Secrets Manager)
POSTGRES_HOST=<rds-endpoint>.region.rds.amazonaws.com
POSTGRES_PORT=5432
POSTGRES_DB=syncsphere
POSTGRES_USER=syncsphere_admin
POSTGRES_PASSWORD=<auto-generated>
```

### Database Schema
- Schema file: `audio-tables.sql`
- Sample data: `demo_data_fixed.sql`
- Automatically imported during setup

## 📊 Monitoring and Management

### View Application Logs
```bash
# View ECS task logs
aws logs tail /ecs/syncsphere --follow --region us-east-1

# View recent logs
aws logs describe-log-groups --region us-east-1
```

### Check Service Status
```bash
# ECS service status
aws ecs describe-services --cluster syncsphere-cluster --services syncsphere-service

# Database status
aws rds describe-db-instances --db-instance-identifier syncsphere-db

# Recent deployments
aws ecs list-tasks --cluster syncsphere-cluster --service syncsphere-service
```

### Update Application
```bash
# Update application code only
./deploy-aws.sh --skip-infrastructure

# Update with new environment
./deploy-aws.sh --region us-west-2
```

## 🚨 Troubleshooting

### Common Issues

#### "AWS credentials not configured"
```bash
aws configure
# Enter your AWS credentials
```

#### "Docker not running"
```bash
# Start Docker Desktop
open -a Docker

# Check Docker status
docker info
```

#### "ECR login failed"
```bash
# Get fresh ECR login
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin <account-id>.dkr.ecr.us-east-1.amazonaws.com
```

#### "ECS service won't start"
```bash
# Check task definition
aws ecs describe-task-definition --task-definition syncsphere-task

# Check service events  
aws ecs describe-services --cluster syncsphere-cluster --services syncsphere-service

# View task logs
aws logs get-log-events --log-group-name /ecs/syncsphere --log-stream-name <stream-name>
```

#### "Database connection failed"
```bash
# Test database connection
psql -h <rds-endpoint> -U syncsphere_admin -d syncsphere

# Check security group
aws ec2 describe-security-groups --group-names syncsphere-db-sg
```

### Getting Help
1. Run validation script: `./validate-aws-deployment.sh`
2. Check AWS CloudWatch logs
3. Review AWS Console for resource status
4. Verify environment variables and secrets

## 🔐 Security Notes

### Implemented Security
- ✅ Database credentials in Secrets Manager
- ✅ VPC security groups for network isolation
- ✅ ECS task execution roles with minimal permissions
- ✅ Encrypted RDS storage
- ✅ Private ECR repository

### Additional Recommendations
- Enable AWS CloudTrail for audit logging
- Set up AWS Config for compliance monitoring
- Use WAF for web application firewall
- Enable VPC Flow Logs
- Implement backup and disaster recovery

## 🔄 Next Steps

After successful deployment:

### 1. Set up Load Balancer (Optional)
```bash
# Create Application Load Balancer manually in AWS Console
# Configure target groups pointing to ECS service
# Set up health checks
```

### 2. Add Custom Domain (Optional)
```bash
# Register domain in Route 53
# Create SSL certificate in ACM
# Configure DNS records
```

### 3. Scale for Production
```bash
# Increase ECS service desired count
aws ecs update-service --cluster syncsphere-cluster --service syncsphere-service --desired-count 2

# Upgrade RDS instance class
aws rds modify-db-instance --db-instance-identifier syncsphere-db --db-instance-class db.t3.small
```

### 4. Set up CI/CD
- GitHub Actions for automated deployment
- AWS CodePipeline integration
- Automated testing pipeline

---

## 📞 Support

For deployment issues:
1. Check the troubleshooting section above
2. Run `./validate-aws-deployment.sh` for diagnostics
3. Review AWS CloudWatch logs
4. Check the AWS Console for resource status

**Estimated deployment time**: 15-30 minutes for complete setup.
